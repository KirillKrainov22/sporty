import streamlit as st
import plotly.graph_objects as go
import plotly.express as px
import pandas as pd

# Our modules
from modules.api_client import api
from modules.cache import cache
from modules.mock_data import MOCK_DATA
from modules.data_utils import prepare_chart_data, calculate_metrics, format_activity_data

# Page config
st.set_page_config(
    page_title="Sporty Dashboard",
    page_icon="üèÜ",
    layout="wide",
    initial_sidebar_state="expanded"
)

st.title("üèÜ Sporty Dashboard")
st.markdown("### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏")

# Sidebar
with st.sidebar:
    st.markdown("### –ù–∞—Å—Ç—Ä–æ–π–∫–∏")
    
    user_id = st.number_input("ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", min_value=1, value=1)
    
    st.markdown("---")
    st.markdown("### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–µ–º")
    
    col1, col2 = st.columns(2)
    with col1:
        if st.button("–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ", type="primary"):
            cache.clear()
            st.rerun()
    
    with col2:
        if st.button("–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à API"):
            api.clear_cache()
            st.rerun()

# Recent activities
st.markdown("## üèÉ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏")

try:
    # This would come from API
    activities = []
    if activities:
        df = format_activity_data(activities[:5])
        if not df.empty:
            st.dataframe(df, use_container_width=True, hide_index=True)
    else:
        st.info("–ù–µ—Ç –Ω–µ–¥–∞–≤–Ω–∏—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π")
except:
    st.info("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è—Ö –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞")

# Activity distribution
st.markdown("## üéØ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º")

activity_dist = user_stats.get('activity_distribution', {})
if not activity_dist:
    activity_dist = {
        "–ë–µ–≥": 35,
        "–í–µ–ª–æ—Å–∏–ø–µ–¥": 25, 
        "–ü–ª–∞–≤–∞–Ω–∏–µ": 20,
        "–ó–∞–ª": 15,
        "–ô–æ–≥–∞": 5
    }

if activity_dist:
    labels = list(activity_dist.keys())
    values = list(activity_dist.values())
    
    fig_pie = px.pie(
        values=values,
        names=labels,
        title='',
        hole=0.4
    )
    fig_pie.update_layout(
        plot_bgcolor='rgba(0,0,0,0)',
        paper_bgcolor='rgba(0,0,0,0)',
        font_color='white',
        height=400
    )
    
    st.plotly_chart(fig_pie, use_container_width=True)

# Footer
st.markdown("---")
st.caption("Sporty Dashboard ‚Ä¢ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Ä¢ –ö—ç—à: 5 –º–∏–Ω—É—Ç")
